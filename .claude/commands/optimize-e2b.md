---
description: Process e2b audit reports and implement fixes (run after npm run optimize:e2b)
---

# Optimize E2B Command

This command processes the JSON audit reports generated by the e2b sandbox pipeline and implements fixes. Run this after `npm run optimize:e2b` completes.

## Prerequisites

Ensure these files exist from the e2b pipeline:
- `docs/audits/raw/axe-results.json`
- `docs/audits/raw/pa11y-results.json`
- `docs/audits/raw/lighthouse-results.json`

If missing, run `npm run optimize:e2b` first.

## Steps

### Step 1: Verify Audit Reports Exist

Check that the audit reports exist in `docs/audits/raw/`. If not found, inform the user to run `npm run optimize:e2b` first.

### Step 2: Parse and Analyze Reports

Read each JSON report and extract issues:

**From axe-results.json:**
- Extract `violations` array
- Each violation has: `id`, `impact`, `description`, `nodes` (affected elements)
- Prioritize by impact: critical > serious > moderate > minor

**From pa11y-results.json:**
- Extract issues array
- Each issue has: `code`, `type`, `message`, `selector`
- Types: error > warning > notice

**From lighthouse-results.json:**
- Extract `categories.accessibility.auditRefs` for a11y issues
- Extract `categories.seo.auditRefs` for SEO issues
- Extract `audits` object for detailed findings
- Focus on audits with `score < 1`

### Step 3: Deduplicate Issues

Many tools report the same issue. Deduplicate by:
1. Matching element selectors/CSS paths
2. Matching issue types (color contrast, missing alt, etc.)
3. Keep the most detailed report for each unique issue

### Step 4: Generate Remediation Specs

For each unique issue, create a spec file:

**Accessibility specs → `docs/accessibility/specs/pending/`**
**SEO specs → `docs/seo/specs/pending/`**

Use this format:

```yaml
---
id: spec-001
title: Fix [issue description]
priority: 1
domain: accessibility  # or seo
source_tools: [axe, pa11y]  # which tools reported this
wcag_criteria: ["1.4.3"]    # if accessibility
depends_on: []
blocks: []
parallel_safe: true
files:
  - src/components/affected/File.tsx
---

## Problem

[Description from tool reports]

## Affected Elements

[List selectors/elements from reports]

## Solution

[Step-by-step fix instructions]

## Verification

Run the audit tools again to confirm the issue is resolved:
- axe-core should no longer report this violation
- Lighthouse score should improve
```

### Step 5: Implement Fixes

After generating all specs, implement them using wave-based execution:

1. **Discover specs**: Read all `docs/*/specs/pending/*.md`
2. **Build waves**: Group by dependencies and `parallel_safe` flag
3. **Execute each wave**:
   - Move specs to `in-progress/`
   - Implement the fixes
   - Run `npm run build` to verify
   - Move specs to `completed/`
4. **Commit each wave**

### Step 6: Final Verification

After all implementations:

1. Run `npm run build` - ensure no build errors
2. Run `npm run test:run` - ensure tests pass
3. Report summary:
   - Issues found per tool
   - Specs generated
   - Specs implemented
   - Files modified

## Output Structure

```
docs/
├── audits/
│   ├── raw/                    # Input from e2b pipeline
│   │   ├── axe-results.json
│   │   ├── pa11y-results.json
│   │   └── lighthouse-results.json
│   └── summary.md              # Generated summary
├── accessibility/
│   └── specs/
│       ├── pending/            # Generated specs
│       ├── in-progress/        # Being implemented
│       └── completed/          # Done
└── seo/
    └── specs/
        ├── pending/
        ├── in-progress/
        └── completed/
```

## Quick Reference

| Tool | Issue Types | Priority Mapping |
|------|-------------|------------------|
| axe-core | violations by impact | critical=1, serious=2, moderate=3, minor=4 |
| pa11y | error/warning/notice | error=2, warning=3, notice=4 |
| Lighthouse | failed audits | score 0=1, score <0.5=2, score <0.9=3 |
